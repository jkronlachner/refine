import{createClient as U}from"@supabase/supabase-js";import{REALTIME_POSTGRES_CHANGES_LISTEN_EVENT as g}from"@supabase/supabase-js";var E={INSERT:"created",UPDATE:"updated",DELETE:"deleted","*":"*"},$={created:g.INSERT,updated:g.UPDATE,deleted:g.DELETE,"*":g.ALL};var y=r=>{switch(r){case"ne":return"neq";case"nin":return"not.in";case"contains":return"ilike";case"ncontains":return"not.ilike";case"containss":return"like";case"ncontainss":return"not.like";case"null":return"is";case"nnull":return"not.is";case"ina":return"cs";case"nina":return"not.cs";case"between":case"nbetween":throw Error(`Operator ${r} is not supported`);default:return r}};var N=(r,o)=>{switch(r.operator){case"eq":return o.eq(r.field,r.value);case"ne":return o.neq(r.field,r.value);case"in":return o.in(r.field,r.value);case"ina":return o.contains(r.field,r.value);case"nina":return o.not(r.field,"cs",`{${r.value.map(t=>`"${t}"`).join(",")}}`);case"gt":return o.gt(r.field,r.value);case"gte":return o.gte(r.field,r.value);case"lt":return o.lt(r.field,r.value);case"lte":return o.lte(r.field,r.value);case"between":if(r.value.length!==2)throw new Error(`[@refinedev/supabase]: Unexpected length ${r.value.length}. Between operator expects a range between 2 values.`);return o.gte(r.field,r.value[0]).lte(r.field,r.value[1]);case"contains":return o.ilike(r.field,`%${r.value}%`);case"containss":return o.like(r.field,`%${r.value}%`);case"null":return o.is(r.field,null);case"startswith":return o.ilike(r.field,`${r.value}%`);case"endswith":return o.ilike(r.field,`%${r.value}`);case"or":{let t=r.value.map(e=>{if(e.operator!=="or"&&e.operator!=="and"&&"field"in e){let n=e.value;return(e.operator==="ina"||e.operator==="nina")&&(n=`{${e.value.map(c=>`"${c}"`).join(",")}}`),(e.operator==="contains"||e.operator==="containss")&&(n=`%${n}%`),e.operator==="startswith"&&(n=`${n}%`),e.operator==="endswith"&&(n=`%${n}`),e.operator==="in"&&(n=`(${e.value.map(c=>`"${c}"`).join(",")})`),`${e.field}.${y(e.operator)}.${n}`}}).join(",");return o.or(t)}case"and":throw Error("Operator 'and' is not supported");default:return o.filter(r.field,y(r.operator),r.value)}};var p=r=>{let o={...r,message:r.message,statusCode:Number.parseInt(r.code)};return Promise.reject(o)};var I=r=>({getList:async({resource:o,pagination:t,filters:e,sorters:n,meta:c})=>{let{current:a=1,pageSize:i=10,mode:d="server"}=t??{},l=(c!=null&&c.schema?r.schema(c.schema):r).from(o).select((c==null?void 0:c.select)??"*",{count:(c==null?void 0:c.count)??"exact"});d==="server"&&l.range((a-1)*i,a*i-1),n==null||n.map(s=>{let[u,T]=s.field.split(/\.(?=[^.]+$)/);u&&T?l.select((c==null?void 0:c.select)??`*, ${u}(${T})`).order(T,{ascending:s.order==="asc",foreignTable:u}):l.order(s.field,{ascending:s.order==="asc"})}),e==null||e.map(s=>{N(s,l)});let{data:w,count:h,error:f}=await l;return f?p(f):{data:w||[],total:h||0}},getMany:async({resource:o,ids:t,meta:e})=>{let c=(e!=null&&e.schema?r.schema(e.schema):r).from(o).select((e==null?void 0:e.select)??"*");e!=null&&e.idColumnName?c.in(e.idColumnName,t):c.in("id",t);let{data:a,error:i}=await c;return i?p(i):{data:a||[]}},create:async({resource:o,variables:t,meta:e})=>{let c=(e!=null&&e.schema?r.schema(e.schema):r).from(o).insert(t);c.select((e==null?void 0:e.select)??"*");let{data:a,error:i}=await c;return i?p(i):{data:(a||[])[0]}},createMany:async({resource:o,variables:t,meta:e})=>{let c=(e!=null&&e.schema?r.schema(e.schema):r).from(o).insert(t);c.select((e==null?void 0:e.select)??"*");let{data:a,error:i}=await c;return i?p(i):{data:a}},update:async({resource:o,id:t,variables:e,meta:n})=>{let a=(n!=null&&n.schema?r.schema(n.schema):r).from(o).update(e);n!=null&&n.idColumnName?a.eq(n.idColumnName,t):a.match({id:t}),a.select((n==null?void 0:n.select)??"*");let{data:i,error:d}=await a;return d?p(d):{data:(i||[])[0]}},updateMany:async({resource:o,ids:t,variables:e,meta:n})=>({data:await Promise.all(t.map(async a=>{let d=(n!=null&&n.schema?r.schema(n.schema):r).from(o).update(e);n!=null&&n.idColumnName?d.eq(n.idColumnName,a):d.match({id:a}),d.select((n==null?void 0:n.select)??"*");let{data:v,error:l}=await d;return l?p(l):(v||[])[0]}))}),getOne:async({resource:o,id:t,meta:e})=>{let c=(e!=null&&e.schema?r.schema(e.schema):r).from(o).select((e==null?void 0:e.select)??"*");e!=null&&e.idColumnName?c.eq(e.idColumnName,t):c.match({id:t});let{data:a,error:i}=await c;return i?p(i):{data:(a||[])[0]}},deleteOne:async({resource:o,id:t,meta:e})=>{let c=(e!=null&&e.schema?r.schema(e.schema):r).from(o).delete();e!=null&&e.idColumnName?c.eq(e.idColumnName,t):c.match({id:t});let{data:a,error:i}=await c;return i?p(i):{data:(a||[])[0]}},deleteMany:async({resource:o,ids:t,meta:e})=>({data:await Promise.all(t.map(async c=>{let i=(e!=null&&e.schema?r.schema(e.schema):r).from(o).delete();e!=null&&e.idColumnName?i.eq(e.idColumnName,c):i.match({id:c});let{data:d,error:v}=await i;return v?p(v):(d||[])[0]}))}),getApiUrl:()=>{throw Error("Not implemented on refine-supabase data provider.")},custom:()=>{throw Error("Not implemented on refine-supabase data provider.")}});var b=r=>({subscribe:({channel:o,types:t,params:e,callback:n,meta:c})=>{var f;let a=o.replace("resources/",""),i=s=>{var u;(t.includes("*")||t.includes(E[s.eventType]))&&(E[s.eventType]!=="created"&&(e==null?void 0:e.ids)!==void 0&&((u=s.new)==null?void 0:u.id)!==void 0?e.ids.map(String).includes(s.new.id.toString())&&n({channel:o,type:E[s.eventType],date:new Date(s.commit_timestamp),payload:s.new}):n({channel:o,type:E[s.eventType],date:new Date(s.commit_timestamp),payload:s.new}))},d=s=>{if(!(!s||(s==null?void 0:s.length)===0))return s.map(u=>{if("field"in u)return`${u.field}=${y(u.operator)}.${u.value}`}).filter(Boolean).join(",")},v=t.map(s=>$[s]).sort((s,u)=>s.localeCompare(u)),l=d(e==null?void 0:e.filters),w=`${o}:${v.join("|")}${l?`:${l}`:""}`,h=r.channel(w);for(let s=0;s<v.length;s++)h=h.on("postgres_changes",{event:v[s],schema:(c==null?void 0:c.schema)||((f=r==null?void 0:r.rest)==null?void 0:f.schemaName)||"public",table:a,filter:l},i);return h.subscribe()},unsubscribe:async o=>{r.removeChannel(o)}});export{U as createClient,I as dataProvider,N as generateFilter,p as handleError,b as liveProvider,E as liveTypes,y as mapOperator,$ as supabaseTypes};
//# sourceMappingURL=index.mjs.map